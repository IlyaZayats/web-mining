<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Модуль 4 — Лекция: Конкурентность I: горутины, каналы и паттерны</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .sticky-actions { top: 84px; } /* под navbar */
    .code-card pre { margin: 0; max-height: 520px; overflow: auto; }
    .code-card code { font-size: .9rem; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
  <div class="container">
    <a class="navbar-brand fw-semibold" href="index.html">ЭУМК Go</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="topNav">
      <ul class="navbar-nav ms-auto gap-1">
        <li class="nav-item"><a class="nav-link" href="index.html#structure">Модули</a></li>
        <li class="nav-item"><a class="nav-link" href="index.html#requirements">ПО</a></li>
      </ul>
    </div>
  </div>
</nav>

<main class="py-4">
  <div class="container">
    <nav aria-label="breadcrumb" class="mb-3">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="index.html">Главная</a></li>
        <li class="breadcrumb-item"><a href="index.html#structure">Структура</a></li>
        <li class="breadcrumb-item active" aria-current="page">Лекция: Конкурентность I: горутины, каналы и паттерны</li>
      </ol>
    </nav>

    <div class="row g-4">
      <!-- Sidebar -->
      <aside class="col-lg-4 col-xl-3">
        <div class="card rounded-4 shadow-sm position-sticky sticky-actions">
          <div class="card-body">
            <div class="fw-semibold mb-2">Навигация</div>
            <div class="list-group small">
              <a class="list-group-item list-group-item-action" href="#theory">Теория</a>
              <a class="list-group-item list-group-item-action" href="#code">Код</a>
              <a class="list-group-item list-group-item-action" href="#practice">Практика</a>
              <a class="list-group-item list-group-item-action" href="#summary">Итоги</a>
            </div>

            <hr>

            <div class="d-grid gap-2">
              <a class="btn btn-outline-secondary" href="index.html#requirements">Требования к ПО</a>
              <a class="btn btn-primary" href="module_type2.html">К тесту</a>
            </div>
          </div>
        </div>
      </aside>

      <!-- Content -->
      <section class="col-lg-8 col-xl-9">
        <div class="card rounded-4 shadow-sm">
          <div class="card-body p-4 p-md-5">
            <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
              <div>
                <div class="badge text-bg-primary mb-2">Тип 1</div>
                <h1 class="h3 mb-1">Лекция: Конкурентность I: горутины, каналы и паттерны</h1>
                <p class="text-secondary mb-0">Горутины, каналы и правила их использования, select для таймаутов и мультиплексирования, паттерн worker pool и отмена операций через context.</p>
              </div>
              <a class="btn btn-outline-primary" href="index.html#structure">К структуре</a>
            </div>

            <hr class="my-4">

            <!-- ===== THEORY BLOCK (SEPARATE) ===== -->
            <section id="theory">
              <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
                <h2 class="h5 mb-0">Теория</h2>
                <span class="badge text-bg-light border text-dark">Блок теории</span>
              </div>

              <div class="p-4 bg-light rounded-4 border">
                
<h3 class="h6 mb-2">Цели и результаты обучения</h3>
<ul class="text-secondary mb-4">
  <li>Понимать модель конкурентности Go: горутины, планировщик, каналы.</li>
  <li>Уметь строить пайплайны и worker pool на каналах.</li>
  <li>Использовать <code>select</code> для мультиплексирования, таймаутов и корректного завершения.</li>
  <li>Применять <code>context</code> для отмены операций и ограничения времени.</li>
</ul>

<h3 class="h6 mb-2">План занятия</h3>
<ul class="text-secondary mb-4">
  <li>Горутины: запуск, жизненный цикл, утечки.</li>
  <li>Каналы: буферизация, направления, закрытие и правила владения.</li>
  <li><code>select</code>: неблокирующие операции, таймауты, fan-in/fan-out.</li>
  <li>Паттерн worker pool и ограничение параллелизма.</li>
  <li>Отмена и таймауты через <code>context</code>.</li>
</ul>

<hr class="my-4">

<h3 class="h6 mb-3">Ключевые тезисы</h3>

<div class="p-3 bg-white border rounded-4 mb-3">
  <div class="fw-semibold mb-1">1) Горутины</div>
  <p class="text-secondary mb-0">Горутина — лёгкий поток выполнения, управляемый рантаймом Go. Частая ошибка — утечки горутин, когда они ждут навсегда (канал/лок/сеть).</p>
</div>

<div class="p-3 bg-white border rounded-4 mb-3">
  <div class="fw-semibold mb-1">2) Каналы</div>
  <p class="text-secondary mb-0">Каналы передают данные между горутинами с синхронизацией. Есть небуферизованные и буферизованные каналы; направления каналов помогают выразить намерение API.</p>
</div>

<div class="p-3 bg-white border rounded-4 mb-3">
  <div class="fw-semibold mb-1">3) Закрытие каналов</div>
  <p class="text-secondary mb-0">Канал закрывает отправитель (владелец жизненного цикла). Получатели канал не закрывают. Чтение из закрытого канала возвращает <code>ok=false</code>.</p>
</div>

<div class="p-3 bg-white border rounded-4 mb-3">
  <div class="fw-semibold mb-1">4) select</div>
  <p class="text-secondary mb-0"><code>select</code> ждёт несколько операций чтения/записи на каналах и позволяет делать таймауты и неблокирующие попытки через <code>default</code>.</p>
</div>

<div class="p-3 bg-white border rounded-4 mb-3">
  <div class="fw-semibold mb-1">5) Worker pool</div>
  <p class="text-secondary mb-0">Worker pool ограничивает параллелизм и равномерно распределяет задачи между воркерами.</p>
</div>

<div class="p-3 bg-white border rounded-4">
  <div class="fw-semibold mb-1">6) context</div>
  <p class="text-secondary mb-0">Контекст передаётся сверху вниз (от входной точки к операциям) и позволяет отменить работу или задать дедлайн.</p>
</div>

              </div>
            </section>

            <hr class="my-4">

            <!-- ===== CODE BLOCK (SEPARATE) ===== -->
            <section id="code">
              <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
                <h2 class="h5 mb-0">Код</h2>
                <span class="badge text-bg-light border text-dark">Блок кода</span>
              </div>

              <div class="alert alert-primary rounded-4" role="alert">
                Все примеры кода в этом блоке
              </div>

              
              <div class="card code-card rounded-4 border mb-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">Горутина: запуск через go</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code1">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
                  <pre><code id="code1">go func() {
    // работа в отдельной горутине
}()</code></pre>
                </div>
              </div>
        
              <div class="card code-card rounded-4 border mb-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">Каналы: небуферизованный и буферизованный</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code2">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
                  <pre><code id="code2">ch := make(chan int)      // небуферизованный
buf := make(chan int, 16) // буферизованный</code></pre>
                </div>
              </div>
        
              <div class="card code-card rounded-4 border mb-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">Направленные каналы (намерение API)</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code3">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
                  <pre><code id="code3">func producer(out chan<- int) { /* only send */ }
func consumer(in <-chan int)  { /* only recv */ }</code></pre>
                </div>
              </div>
        
              <div class="card code-card rounded-4 border mb-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">Чтение из закрытого канала: ok=false</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code4">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
                  <pre><code id="code4">v, ok := <-ch
if !ok {
    // канал закрыт
}</code></pre>
                </div>
              </div>
        
              <div class="card code-card rounded-4 border mb-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">select: таймаут через time.After</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code5">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
                  <pre><code id="code5">select {
case v := <-ch:
    _ = v
case <-time.After(200 * time.Millisecond):
    // timeout
}</code></pre>
                </div>
              </div>
        
              <div class="card code-card rounded-4 border mb-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">select: неблокирующая попытка (default)</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code6">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
                  <pre><code id="code6">select {
case ch <- 1:
    // отправили
default:
    // канал занят
}</code></pre>
                </div>
              </div>
        
              <div class="card code-card rounded-4 border mb-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">Worker pool (ограничение параллелизма)</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code7">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
                  <pre><code id="code7">package main

import (
    "fmt"
    "sync"
)

func worker(id int, jobs <-chan int, results chan<- int, wg *sync.WaitGroup) {
    defer wg.Done()
    for j := range jobs {
        results <- j * j
        fmt.Println("worker", id, "processed", j)
    }
}

func main() {
    jobs := make(chan int)
    results := make(chan int, 100)

    var wg sync.WaitGroup
    for i := 0; i < 3; i++ {
        wg.Add(1)
        go worker(i, jobs, results, &wg)
    }

    for j := 1; j <= 10; j++ {
        jobs <- j
    }
    close(jobs)

    wg.Wait()
    close(results)

    for r := range results {
        _ = r
    }
}</code></pre>
                </div>
              </div>
        
              <div class="card code-card rounded-4 border ">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">context: дедлайн и отмена</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code8">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
                  <pre><code id="code8">ctx, cancel := context.WithTimeout(context.Background(), 500*time.Millisecond)
defer cancel()

select {
case <-ctx.Done():
    // отмена или таймаут
case v := <-ch:
    _ = v
}</code></pre>
                </div>
              </div>
        
            </section>

            <hr class="my-4">

            <!-- PRACTICE -->
            <section id="practice">
              <h2 class="h5 mb-3">Практика</h2>
              <div class="alert alert-secondary rounded-4">
                Упражнения для закрепления темы.
              </div>
              <ol class="text-secondary mb-0">
                <li>Запусти 10 горутин, которые пишут в общий канал, и собери результаты в одной горутине (fan-in).</li>
<li>Сделай producer/consumer с направленными каналами и корректным закрытием канала отправителем.</li>
<li>Добавь таймаут чтения из канала через select + time.After.</li>
<li>Реализуй неблокирующую отправку в канал через ветку default и обработай ситуацию «канал занят».</li>
<li>Собери worker pool на 3 воркера для обработки N задач и дождись завершения через WaitGroup.</li>
<li>Добавь отмену вычислений через context: прекрати обработку задач при истечении дедлайна.</li>
              </ol>
            </section>

            <hr class="my-4">

            <!-- SUMMARY -->
            <section id="summary">
              <h2 class="h5 mb-3">Итоги</h2>
              <ul class="text-secondary mb-4">
                <li>Горутины и каналы дают простую модель конкурентности без ручного управления потоками.</li>
<li>Закрытие канала — ответственность отправителя (владельца жизненного цикла).</li>
<li>select и context — базовые инструменты для таймаутов, отмены и корректного завершения.</li>
              </ul>

              <div class="p-3 border rounded-4 mb-4">
                <div class="fw-semibold mb-2">Контрольные вопросы</div>
                <ul class="text-secondary mb-0">
                  <li>Чем отличается буферизованный канал от небуферизованного?</li>
<li>Кто должен закрывать канал и почему?</li>
<li>Как реализовать таймаут на чтение из канала?</li>
<li>Что такое утечка горутин и как её избежать?</li>
<li>Зачем нужен context и где его правильно создавать?</li>
                </ul>
              </div>

              <div class="d-flex flex-wrap gap-2">
                <a class="btn btn-outline-secondary" href="index.html#structure">Назад к модулям</a>
                <a class="btn btn-primary" href="module_type2.html">Перейти к тесту</a>
              </div>
            </section>
          </div>
        </div>
      </section>
    </div>
  </div>
</main>

<!-- Toast for copy -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
  <div id="copyToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">Код скопирован</strong>
      <small>OK</small>
      <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
    </div>
    <div class="toast-body">Фрагмент кода помещён в буфер обмена.</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const toastEl = document.getElementById('copyToast');
  const toast = new bootstrap.Toast(toastEl);

  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('[data-copy-target]');
    if (!btn) return;

    const selector = btn.getAttribute('data-copy-target');
    const codeEl = document.querySelector(selector);
    if (!codeEl) return;

    const text = codeEl.innerText;
    try {
      await navigator.clipboard.writeText(text);
      toast.show();
    } catch {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      toast.show();
    }
  });
</script>
</body>
</html>
