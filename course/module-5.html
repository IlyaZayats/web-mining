<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Модуль 5 — Лекция: Конкурентность II: синхронизация и диагностика</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .sticky-actions { top: 84px; } /* под navbar */
    .code-card pre { margin: 0; max-height: 520px; overflow: auto; }
    .code-card code { font-size: .9rem; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
  <div class="container">
    <a class="navbar-brand fw-semibold" href="index.html">ЭУМК Go</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="topNav">
      <ul class="navbar-nav ms-auto gap-1">
        <li class="nav-item"><a class="nav-link" href="index.html#structure">Модули</a></li>
        <li class="nav-item"><a class="nav-link" href="index.html#requirements">ПО</a></li>
      </ul>
    </div>
  </div>
</nav>

<main class="py-4">
  <div class="container">
    <nav aria-label="breadcrumb" class="mb-3">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="index.html">Главная</a></li>
        <li class="breadcrumb-item"><a href="index.html#structure">Структура</a></li>
        <li class="breadcrumb-item active" aria-current="page">Лекция: Конкурентность II: синхронизация и диагностика</li>
      </ol>
    </nav>

    <div class="row g-4">
      <!-- Sidebar -->
      <aside class="col-lg-4 col-xl-3">
        <div class="card rounded-4 shadow-sm position-sticky sticky-actions">
          <div class="card-body">
            <div class="fw-semibold mb-2">Навигация</div>
            <div class="list-group small">
              <a class="list-group-item list-group-item-action" href="#theory">Теория</a>
              <a class="list-group-item list-group-item-action" href="#code">Код</a>
              <a class="list-group-item list-group-item-action" href="#practice">Практика</a>
              <a class="list-group-item list-group-item-action" href="#summary">Итоги</a>
            </div>

            <hr>

            <div class="d-grid gap-2">
              <a class="btn btn-outline-secondary" href="index.html#requirements">Требования к ПО</a>
              <a class="btn btn-primary" href="module_type2.html">К тесту</a>
            </div>
          </div>
        </div>
      </aside>

      <!-- Content -->
      <section class="col-lg-8 col-xl-9">
        <div class="card rounded-4 shadow-sm">
          <div class="card-body p-4 p-md-5">
            <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
              <div>
                <div class="badge text-bg-primary mb-2">Тип 1</div>
                <h1 class="h3 mb-1">Лекция: Конкурентность II: синхронизация и диагностика</h1>
                <p class="text-secondary mb-0">Примитивы sync для защиты разделяемых данных, WaitGroup/Once/atomic и практическая диагностика: race detector и типовые причины дедлоков.</p>
              </div>
              <a class="btn btn-outline-primary" href="index.html#structure">К структуре</a>
            </div>

            <hr class="my-4">

            <!-- ===== THEORY BLOCK (SEPARATE) ===== -->
            <section id="theory">
              <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
                <h2 class="h5 mb-0">Теория</h2>
                <span class="badge text-bg-light border text-dark">Блок теории</span>
              </div>

              <div class="p-4 bg-light rounded-4 border">
                
<h3 class="h6 mb-2">Цели и результаты обучения</h3>
<ul class="text-secondary mb-4">
  <li>Выбирать между каналами и примитивами <code>sync</code> для защиты разделяемых данных.</li>
  <li>Использовать <code>Mutex</code>/<code>RWMutex</code>/<code>WaitGroup</code>/<code>Once</code>/<code>atomic</code> в типовых сценариях.</li>
  <li>Понимать, почему <code>map</code> и другие структуры не потокобезопасны по умолчанию.</li>
  <li>Применять race detector и базовые приёмы отладки дедлоков/блокировок.</li>
</ul>

<h3 class="h6 mb-2">План занятия</h3>
<ul class="text-secondary mb-4">
  <li>Модель памяти и гонки данных: что такое data race.</li>
  <li><code>sync.Mutex</code> и <code>sync.RWMutex</code>: критические секции, паттерны.</li>
  <li><code>sync.WaitGroup</code> и <code>sync.Once</code>: координация и инициализация.</li>
  <li><code>atomic</code>: когда уместен, ограничения.</li>
  <li>Диагностика: race detector, типовые причины дедлоков.</li>
</ul>

<hr class="my-4">

<h3 class="h6 mb-3">Ключевые тезисы</h3>

<div class="p-3 bg-white border rounded-4 mb-3">
  <div class="fw-semibold mb-1">1) Data race</div>
  <p class="text-secondary mb-0">Гонка данных возникает, когда две горутины обращаются к одной памяти одновременно, и хотя бы одна операция — запись, без синхронизации.</p>
</div>

<div class="p-3 bg-white border rounded-4 mb-3">
  <div class="fw-semibold mb-1">2) Mutex / RWMutex</div>
  <p class="text-secondary mb-0">Mutex обеспечивает взаимное исключение. RWMutex позволяет параллельные чтения при редких записях.</p>
</div>

<div class="p-3 bg-white border rounded-4 mb-3">
  <div class="fw-semibold mb-1">3) WaitGroup / Once</div>
  <p class="text-secondary mb-0">WaitGroup — ожидание завершения набора горутин. Once — однократная инициализация.</p>
</div>

<div class="p-3 bg-white border rounded-4 mb-3">
  <div class="fw-semibold mb-1">4) atomic</div>
  <p class="text-secondary mb-0">atomic уместен для простых счётчиков/флагов без сложных инвариантов. Для составных структур обычно нужен Mutex.</p>
</div>

<div class="p-3 bg-white border rounded-4">
  <div class="fw-semibold mb-1">5) Диагностика</div>
  <ul class="text-secondary mb-0">
    <li>Race detector помогает находить гонки данных в тестах и отладочных запусках.</li>
    <li>Дедлоки часто возникают из-за циклов ожидания локов, зависших каналов, ошибок WaitGroup и nil-каналов в select.</li>
  </ul>
</div>

              </div>
            </section>

            <hr class="my-4">

            <!-- ===== CODE BLOCK (SEPARATE) ===== -->
            <section id="code">
              <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
                <h2 class="h5 mb-0">Код</h2>
                <span class="badge text-bg-light border text-dark">Блок кода</span>
              </div>

              <div class="alert alert-primary rounded-4" role="alert">
                Все примеры кода в этом блоке. У каждого — кнопка «Скопировать».
              </div>

              
              <div class="card code-card rounded-4 border mb-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">Mutex: защита критической секции (SafeCounter)</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code1">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
                  <pre><code id="code1">package main

import (
    "fmt"
    "sync"
)

type SafeCounter struct {
    mu sync.Mutex
    n  int
}

func (c *SafeCounter) Inc() {
    c.mu.Lock()
    c.n++
    c.mu.Unlock()
}

func (c *SafeCounter) Value() int {
    c.mu.Lock()
    defer c.mu.Unlock()
    return c.n
}

func main() {
    var c SafeCounter
    var wg sync.WaitGroup
    for i := 0; i < 100; i++ {
        wg.Add(1)
        go func() {
            defer wg.Done()
            c.Inc()
        }()
    }
    wg.Wait()
    fmt.Println(c.Value())
}</code></pre>
                </div>
              </div>
        
              <div class="card code-card rounded-4 border mb-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">RWMutex: много чтений, мало записей (Cache)</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code2">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
                  <pre><code id="code2">type Cache struct {
    mu sync.RWMutex
    m  map[string]string
}

func (c *Cache) Get(k string) (string, bool) {
    c.mu.RLock()
    defer c.mu.RUnlock()
    v, ok := c.m[k]
    return v, ok
}

func (c *Cache) Set(k, v string) {
    c.mu.Lock()
    c.m[k] = v
    c.mu.Unlock()
}</code></pre>
                </div>
              </div>
        
              <div class="card code-card rounded-4 border mb-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">WaitGroup и Once: однократная инициализация</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code3">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
                  <pre><code id="code3">var once sync.Once
var cfg *Config

func LoadConfig() *Config {
    once.Do(func() {
        cfg = &Config{/*...*/}
    })
    return cfg
}</code></pre>
                </div>
              </div>
        
              <div class="card code-card rounded-4 border mb-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">atomic: счётчик/флаг</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code4">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
                  <pre><code id="code4">var n int64
atomic.AddInt64(&n, 1)
v := atomic.LoadInt64(&n)</code></pre>
                </div>
              </div>
        
              <div class="card code-card rounded-4 border mb-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">Race detector (команды)</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code5">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
                  <pre><code id="code5">go test -race ./...
go run -race .</code></pre>
                </div>
              </div>
        
              <div class="card code-card rounded-4 border ">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">Типовые причины дедлоков (шпаргалка)</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code6">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
                  <pre><code id="code6">// цикл ожидания локов (A держит лок и ждёт B; B держит лок и ждёт A)
// отправка/чтение в канал без потребителя/отправителя
// забыли вызвать wg.Done() или вызвали wg.Add() после запуска горутины
// использование nil-канала в select (ветка никогда не сработает)</code></pre>
                </div>
              </div>
        
            </section>

            <hr class="my-4">

            <!-- PRACTICE -->
            <section id="practice">
              <h2 class="h5 mb-3">Практика</h2>
              <div class="alert alert-secondary rounded-4">
                Упражнения для закрепления темы.
              </div>
              <ol class="text-secondary mb-0">
                <li>Смоделируй data race на общем счётчике (без синхронизации), затем исправь через Mutex и сравни поведение.</li>
<li>Сделай кэш на map и защити его через RWMutex; проверь параллельные чтения и записи.</li>
<li>Собери сценарий с WaitGroup: запусти N горутин и корректно дождись завершения.</li>
<li>Добавь ленивую инициализацию конфигурации через sync.Once.</li>
<li>Сделай счётчик запросов через atomic и сравни с Mutex по простоте/ограничениям.</li>
<li>Запусти проект с race detector и выпиши, что он показывает при найденной гонке.</li>
<li>Собери пример дедлока (например, забытый wg.Done или зависший канал) и найди причину.</li>
              </ol>
            </section>

            <hr class="my-4">

            <!-- SUMMARY -->
            <section id="summary">
              <h2 class="h5 mb-3">Итоги</h2>
              <ul class="text-secondary mb-4">
                <li>Mutex/RWMutex защищают разделяемые данные; RWMutex полезен при доминировании чтений.</li>
<li>WaitGroup — для ожидания группы горутин, Once — для однократной инициализации.</li>
<li>atomic подходит для простых примитивов; при сложных инвариантах используйте Mutex.</li>
<li>Race detector — обязательный инструмент для поиска гонок; дедлоки часто связаны с неверной координацией.</li>
              </ul>

              <div class="p-3 border rounded-4 mb-4">
                <div class="fw-semibold mb-2">Контрольные вопросы</div>
                <ul class="text-secondary mb-0">
                  <li>Что такое data race и почему это баг даже если программа «обычно работает»?</li>
<li>В чём разница Mutex и RWMutex и когда RWMutex даёт выигрыш?</li>
<li>Какие типовые ошибки приводят к дедлоку с WaitGroup?</li>
<li>Когда atomic предпочтительнее Mutex, а когда наоборот?</li>
<li>Как запустить race detector и что он показывает?</li>
                </ul>
              </div>

              <div class="d-flex flex-wrap gap-2">
                <a class="btn btn-outline-secondary" href="index.html#structure">Назад к модулям</a>
                <a class="btn btn-primary" href="module_type2.html">Перейти к тесту</a>
              </div>
            </section>
          </div>
        </div>
      </section>
    </div>
  </div>
</main>

<!-- Toast for copy -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
  <div id="copyToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">Код скопирован</strong>
      <small>OK</small>
      <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
    </div>
    <div class="toast-body">Фрагмент кода помещён в буфер обмена.</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const toastEl = document.getElementById('copyToast');
  const toast = new bootstrap.Toast(toastEl);

  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('[data-copy-target]');
    if (!btn) return;

    const selector = btn.getAttribute('data-copy-target');
    const codeEl = document.querySelector(selector);
    if (!codeEl) return;

    const text = codeEl.innerText;
    try {
      await navigator.clipboard.writeText(text);
      toast.show();
    } catch {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      toast.show();
    }
  });
</script>
</body>
</html>
