<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Модуль 2 — Лекция: Срезы, мапы, структуры, интерфейсы и ошибки</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .sticky-actions { top: 84px; } /* под navbar */
    .code-card pre { margin: 0; max-height: 520px; overflow: auto; }
    .code-card code { font-size: .9rem; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
  <div class="container">
    <a class="navbar-brand fw-semibold" href="index.html">ЭУМК Go</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="topNav">
      <ul class="navbar-nav ms-auto gap-1">
        <li class="nav-item"><a class="nav-link" href="index.html#structure">Модули</a></li>
        <li class="nav-item"><a class="nav-link" href="index.html#requirements">ПО</a></li>
      </ul>
    </div>
  </div>
</nav>

<main class="py-4">
  <div class="container">
    <nav aria-label="breadcrumb" class="mb-3">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="index.html">Главная</a></li>
        <li class="breadcrumb-item"><a href="index.html#structure">Структура</a></li>
        <li class="breadcrumb-item active" aria-current="page">Модуль 2 — Лекция</li>
      </ol>
    </nav>

    <div class="row g-4">
      <!-- Sidebar -->
      <aside class="col-lg-4 col-xl-3">
        <div class="card rounded-4 shadow-sm position-sticky sticky-actions">
          <div class="card-body">
            <div class="fw-semibold mb-2">Навигация</div>
            <div class="list-group small">
              <a class="list-group-item list-group-item-action" href="#theory">Теория</a>
              <a class="list-group-item list-group-item-action" href="#code">Код</a>
              <a class="list-group-item list-group-item-action" href="#practice">Практика</a>
              <a class="list-group-item list-group-item-action" href="#summary">Итоги</a>
            </div>

            <hr>

            <div class="d-grid gap-2">
              <a class="btn btn-outline-secondary" href="index.html#requirements">Требования к ПО</a>
              <a class="btn btn-primary" href="module_type2.html">К тесту</a>
            </div>
          </div>
        </div>
      </aside>

      <!-- Content -->
      <section class="col-lg-8 col-xl-9">
        <div class="card rounded-4 shadow-sm">
          <div class="card-body p-4 p-md-5">
            <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
              <div>
                <div class="badge text-bg-primary mb-2">Тип 1</div>
                <h1 class="h3 mb-1">Лекция: Срезы, мапы, структуры, интерфейсы и ошибки</h1>
                <p class="text-secondary mb-0">
                  Разбираем устройство slice (len/cap/backing array), особенности map, структуры/методы и embedding,
                  интерфейсы как контракт поведения, а также современную работу с ошибками (wrap, Is/As, typed errors)
                  и границы применения panic/recover.
                </p>
              </div>
              <a class="btn btn-outline-primary" href="index.html#structure">К структуре</a>
            </div>

            <hr class="my-4">

            <!-- ===== THEORY BLOCK (SEPARATE) ===== -->
            <section id="theory">
              <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
                <h2 class="h5 mb-0">Теория</h2>
                <span class="badge text-bg-light border text-dark">Блок теории</span>
              </div>

              <div class="p-4 bg-light rounded-4 border">
                <h3 class="h6 mb-2">Цели и результаты обучения</h3>
                <ul class="text-secondary mb-4">
                  <li>Понимать устройство <strong>slice</strong> (len/cap/backing array) и безопасно использовать <code>append</code>/<code>copy</code>.</li>
                  <li>Уверенно работать с <strong>map</strong>, знать <em>comma ok</em>, особенности порядка и <em>nil-map</em>.</li>
                  <li>Проектировать <strong>структуры и методы</strong>; выбирать <em>pointer/value receiver</em>.</li>
                  <li>Понимать <strong>интерфейсы</strong> как контракт поведения и применять принцип «интерфейс по месту использования».</li>
                  <li>Работать с <strong>ошибками</strong>: оборачивание, <code>errors.Is</code>/<code>errors.As</code>, typed errors; понимать границы <code>panic</code>.</li>
                </ul>

                <h3 class="h6 mb-2">План занятия</h3>
                <ul class="text-secondary mb-4">
                  <li>Срезы и массивы: модель данных, <code>append</code>, <code>copy</code>, nil vs empty, ограничение capacity.</li>
                  <li>Мапы: операции, <em>comma ok</em>, особенности и ограничения.</li>
                  <li>Структуры и методы: receivers, композиция через embedding.</li>
                  <li>Интерфейсы: неявная реализация, проектирование интерфейсов.</li>
                  <li>Ошибки: error как значение, <code>%w</code>, <code>errors.Is</code>/<code>errors.As</code>, typed errors, <code>panic</code>/<code>recover</code>.</li>
                </ul>

                <hr class="my-4">

                <h3 class="h6 mb-2">Лекция (2 акад. часа): основные тезисы</h3>

                <div class="p-3 bg-white border rounded-4 mb-3">
                  <div class="fw-semibold mb-1">1) Срезы: устройство и подводные камни</div>
                  <p class="text-secondary mb-0">
                    Slice — это «заголовок» (указатель на массив + len + cap). Копирование среза копирует заголовок,
                    но данные могут оставаться общими. <code>append</code> может переиспользовать общий backing array
                    или создать новый — отсюда побочные эффекты.
                  </p>
                </div>

                <div class="p-3 bg-white border rounded-4 mb-3">
                  <div class="fw-semibold mb-1">2) Ограничение capacity трёхиндексным срезом</div>
                  <p class="text-secondary mb-0">
                    Трёхиндексный срез позволяет ограничить <code>cap</code>, чтобы гарантировать,
                    что <code>append</code> создаст новый массив.
                  </p>
                </div>

                <div class="p-3 bg-white border rounded-4 mb-3">
                  <div class="fw-semibold mb-1">3) nil vs empty slice</div>
                  <p class="text-secondary mb-0">
                    Оба варианта корректны для <code>range</code> и <code>append</code>, но различаются при сериализации
                    и проверках на <code>nil</code>.
                  </p>
                </div>

                <div class="p-3 bg-white border rounded-4 mb-3">
                  <div class="fw-semibold mb-1">4) Map: операции и особенности</div>
                  <ul class="text-secondary mb-0">
                    <li>Map не гарантирует порядок обхода и не потокобезопасна без синхронизации.</li>
                    <li>Нулевое значение map — <code>nil</code>; запись в <code>nil-map</code> приводит к <code>panic</code>.</li>
                    <li><em>comma ok</em> позволяет отличить отсутствующий ключ от нулевого значения.</li>
                  </ul>
                </div>

                <div class="p-3 bg-white border rounded-4 mb-3">
                  <div class="fw-semibold mb-1">5) Структуры и методы</div>
                  <p class="text-secondary mb-0">
                    Pointer receiver нужен, если метод меняет состояние или структура крупная.
                  </p>
                </div>

                <div class="p-3 bg-white border rounded-4 mb-3">
                  <div class="fw-semibold mb-1">6) Композиция (embedding) вместо наследования</div>
                  <p class="text-secondary mb-0">
                    Встраивание (embedding) позволяет «наследовать» поведение через композицию: методы встроенного типа
                    доступны у внешнего типа.
                  </p>
                </div>

                <div class="p-3 bg-white border rounded-4 mb-3">
                  <div class="fw-semibold mb-1">7) Интерфейсы: контракт поведения</div>
                  <p class="text-secondary mb-0">
                    Тип реализует интерфейс неявно — достаточно иметь нужные методы.
                    Рекомендуется объявлять интерфейсы со стороны потребителя («интерфейс по месту использования»).
                  </p>
                </div>

                <div class="p-3 bg-white border rounded-4">
                  <div class="fw-semibold mb-1">8) Ошибки: оборачивание и классификация</div>
                  <ul class="text-secondary mb-0">
                    <li>Оборачивайте ошибки контекстом и используйте <code>%w</code> для сохранения причины.</li>
                    <li>Используйте <code>errors.Is</code> для сравнения причин и <code>errors.As</code> для typed errors.</li>
                    <li><code>panic/recover</code> — для исключительных ситуаций (обычно баг/нарушение инварианта), не для обычной логики.</li>
                  </ul>
                </div>
              </div>
            </section>

            <hr class="my-4">

            <!-- ===== CODE BLOCK (SEPARATE) ===== -->
            <section id="code">
              <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
                <h2 class="h5 mb-0">Код</h2>
                <span class="badge text-bg-light border text-dark">Блок кода</span>
              </div>

              <div class="alert alert-primary rounded-4" role="alert">
                Примеры кода из Модуля 2».
              </div>

              <!-- 1. slice header shared backing array -->
              <div class="card code-card rounded-4 border mb-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">Срезы: общий backing array при копировании заголовка</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code1">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
<pre><code id="code1">package main

import "fmt"

func main() {
    a := []int{1, 2, 3}
    b := a
    b[0] = 999
    fmt.Println("a:", a)
    fmt.Println("b:", b)
}</code></pre>
                </div>
              </div>

              <!-- 2. three-index slicing -->
              <div class="card code-card rounded-4 border mb-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">Ограничение capacity трёхиндексным срезом</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code2">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
<pre><code id="code2">package main

import "fmt"

func main() {
    a := []int{1, 2, 3, 4}
    b := a[:2:2]      // len=2 cap=2
    b = append(b, 99) // новый массив
    fmt.Println("a:", a)
    fmt.Println("b:", b)
}</code></pre>
                </div>
              </div>

              <!-- 3. idiomatic clone -->
              <div class="card code-card rounded-4 border mb-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">Клонирование среза (идиоматично)</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code3">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
<pre><code id="code3">b := append([]int(nil), a...)</code></pre>
                </div>
              </div>

              <!-- 4. nil vs empty slice -->
              <div class="card code-card rounded-4 border mb-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">nil vs empty slice</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code4">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
<pre><code id="code4">package main

import "fmt"

func main() {
    var s1 []int
    s2 := []int{}
    fmt.Println(len(s1), s1 == nil) // 0 true
    fmt.Println(len(s2), s2 == nil) // 0 false
}</code></pre>
                </div>
              </div>

              <!-- 5. map operations + comma ok -->
              <div class="card code-card rounded-4 border mb-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">Map: операции, comma ok, delete</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code5">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
<pre><code id="code5">package main

import "fmt"

func main() {
    m := map[string]int{"go": 1}
    v, ok := m["missing"]
    fmt.Println(v, ok) // 0 false
    delete(m, "go")
}</code></pre>
                </div>
              </div>

              <!-- 6. nil map panic -->
              <div class="card code-card rounded-4 border mb-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">nil-map: запись приводит к panic</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code6">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
<pre><code id="code6">var m map[string]int
// m["x"] = 1 // panic</code></pre>
                </div>
              </div>

              <!-- 7. struct methods + pointer receiver -->
              <div class="card code-card rounded-4 border mb-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">Структуры и методы: pointer/value receiver</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code7">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
<pre><code id="code7">package main

import "fmt"

type Counter struct{ n int }

func (c *Counter) Inc() { c.n++ }
func (c Counter) Value() int { return c.n }

func main() {
    var c Counter
    c.Inc()
    fmt.Println(c.Value())
}</code></pre>
                </div>
              </div>

              <!-- 8. embedding -->
              <div class="card code-card rounded-4 border mb-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">Композиция (embedding) вместо наследования</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code8">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
<pre><code id="code8">package main

import "fmt"

type Logger struct{}
func (Logger) Log(msg string) { fmt.Println("LOG:", msg) }

type Service struct {
    Logger
    Name string
}

func main() {
    s := Service{Name: "billing"}
    s.Log("started")
}</code></pre>
                </div>
              </div>

              <!-- 9. interfaces -->
              <div class="card code-card rounded-4 border mb-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">Интерфейсы: неявная реализация (пример с fmt.Stringer)</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code9">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
<pre><code id="code9">package main

import "fmt"

type User struct{ Name string }
func (u User) String() string { return "User(" + u.Name + ")" }

func Print(s fmt.Stringer) { fmt.Println(s.String()) }

func main() { Print(User{Name: "Alice"}) }</code></pre>
                </div>
              </div>

              <!-- 10. errors wrap + Is -->
              <div class="card code-card rounded-4 border mb-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">Ошибки: wrapping (%w) и errors.Is</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code10">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
<pre><code id="code10">package main

import (
    "errors"
    "fmt"
)

var ErrNotFound = errors.New("not found")

func load() error {
    return fmt.Errorf("load config: %w", ErrNotFound)
}

func main() {
    err := load()
    if errors.Is(err, ErrNotFound) {
        fmt.Println("handle not found")
    }
}</code></pre>
                </div>
              </div>

              <!-- 11. typed errors + As -->
              <div class="card code-card rounded-4 border mb-3">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">Typed errors и errors.As</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code11">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
<pre><code id="code11">package main

import (
    "errors"
    "fmt"
)

type ValidationError struct {
    Field string
    Msg   string
}

func (e *ValidationError) Error() string { return e.Field + ": " + e.Msg }

func validateName(name string) error {
    if name == "" {
        return &ValidationError{Field: "name", Msg: "empty"}
    }
    return nil
}

func main() {
    err := validateName("")
    var ve *ValidationError
    if errors.As(err, &ve) {
        fmt.Println("field:", ve.Field)
    }
}</code></pre>
                </div>
              </div>

              <!-- 12. panic/recover snippet -->
              <div class="card code-card rounded-4 border">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">panic/recover: шаблон (для исключительных ситуаций)</div>
                  <button class="btn btn-sm btn-outline-primary" data-copy-target="#code12">Скопировать</button>
                </div>
                <div class="card-body bg-light rounded-bottom-4">
<pre><code id="code12">defer func() {
    if r := recover(); r != nil {
        // логируем и завершаем корректно
    }
}()</code></pre>
                </div>
              </div>
            </section>

            <hr class="my-4">

            <!-- PRACTICE -->
            <section id="practice">
              <h2 class="h5 mb-3">Практика</h2>
              <div class="alert alert-secondary rounded-4">
                Мини-практика по модулю 2.
              </div>

              <ol class="text-secondary mb-0">
                <li>Напиши пример со срезом, где два среза разделяют один backing array, и продемонстрируй побочный эффект.</li>
                <li>Сделай «безопасный» вариант через трёхиндексный срез или клонирование.</li>
                <li>Собери несколько операций с map: чтение с comma ok, delete, и отдельно покажи, что запись в nil-map паникует.</li>
                <li>Реализуй структуру-счётчик с методами: инкремент через pointer receiver и чтение значения через value receiver.</li>
                <li>Сделай embedding (Logger → Service) и вызови метод встроенного типа.</li>
                <li>Опиши маленький интерфейс со стороны потребителя и реализуй его неявно в типе.</li>
                <li>Собери пример ошибок: sentinel error + wrapping через <code>%w</code> и проверка через <code>errors.Is</code>, затем typed error + <code>errors.As</code>.</li>
              </ol>
            </section>

            <hr class="my-4">

            <!-- SUMMARY -->
            <section id="summary">
              <h2 class="h5 mb-3">Итоги</h2>
              <ul class="text-secondary mb-4">
                <li><strong>Slice</strong> — представление над массивом; <code>append</code> и <code>cap</code> определяют, будут ли общие побочные эффекты.</li>
                <li><strong>Map</strong> удобна, но без порядка и без потокобезопасности.</li>
                <li><strong>Интерфейсы</strong> описывают поведение; ошибки следует оборачивать контекстом и проверять через <code>errors.Is</code>/<code>errors.As</code>.</li>
              </ul>

              <div class="p-3 border rounded-4 mb-4">
                <div class="fw-semibold mb-2">Контрольные вопросы</div>
                <ul class="text-secondary mb-0">
                  <li>Что означает <code>len</code> и <code>cap</code> у slice? В каких случаях <code>append</code> создаёт новый массив?</li>
                  <li>Чем nil-slice отличается от empty-slice и когда это важно?</li>
                  <li>Почему нельзя полагаться на порядок <code>range</code> по map?</li>
                  <li>Когда нужно использовать pointer receiver?</li>
                  <li>Что делает <code>fmt.Errorf</code> с <code>%w</code> и как работает <code>errors.Is</code>/<code>errors.As</code>?</li>
                </ul>
              </div>

              <div class="d-flex flex-wrap gap-2">
                <a class="btn btn-outline-secondary" href="index.html#structure">Назад к модулям</a>
                <a class="btn btn-primary" href="module_type2.html">Перейти к тесту</a>
              </div>
            </section>
          </div>
        </div>
      </section>
    </div>
  </div>
</main>

<!-- Toast for copy -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
  <div id="copyToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">Код скопирован</strong>
      <small>OK</small>
      <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
    </div>
    <div class="toast-body">Фрагмент кода помещён в буфер обмена.</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const toastEl = document.getElementById('copyToast');
  const toast = new bootstrap.Toast(toastEl);

  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('[data-copy-target]');
    if (!btn) return;

    const selector = btn.getAttribute('data-copy-target');
    const codeEl = document.querySelector(selector);
    if (!codeEl) return;

    const text = codeEl.innerText;
    try {
      await navigator.clipboard.writeText(text);
      toast.show();
    } catch {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      toast.show();
    }
  });
</script>
</body>
</html>
